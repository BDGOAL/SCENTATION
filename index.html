import React, { useState, useCallback, useMemo } from 'react';
import logoImage from 'figma:asset/ee53a9af49c512b0092c46a5136839eadad379b4.png';

type ScoreKey = 'N' | 'S' | 'J' | 'P' | 'T' | 'F' | 'E' | 'I';
type Page = 'intro' | 1 | 2 | 3 | 4 | 'result';
type CategoryKey = 'NT' | 'NF' | 'SJ' | 'SP';

interface ResultData {
Â  category: string;
Â  desc: string;
Â  fragrance: string;
}

const resultsMap: Record<CategoryKey, ResultData> = {
Â  NT: {
Â  Â  category: 'ä¸€ã€åˆ†æå®¶ (The Analysts)',
Â  Â  desc: 'ä½œç‚ºé‚è¼¯è‡³ä¸Šã€è¿½æ±‚æ•ˆç‡èˆ‡è¤‡é›œæ€§çš„åˆ†æå®¶ï¼Œæ‚¨ä¸å–œæ­¡å¹³åº¸ï¼Œåæ„›èƒ½æ¿€ç™¼æ€è€ƒæˆ–å¸¶æœ‰ç¥ç§˜æ„Ÿçš„æ°£å‘³ã€‚æ‚¨çš„é¦™æ°£å¿…é ˆå±•ç¾å‡ºç¨ç‰¹çš„å“å‘³èˆ‡æ™ºæ…§ã€‚',
Â  Â  fragrance: 'ğŸª¶ æœ¨è³ªèª¿ (Woody) / ğŸŒ² è¥¿æ™®èª¿ (Chypre) / ğŸŒ¿ èŠ³é¦™èª¿ (Aromatic)'
Â  },
Â  NF: {
Â  Â  category: 'äºŒã€å¤–äº¤å®¶ (The Diplomats)',
Â  Â  desc: 'ä½œç‚ºæƒ…æ„Ÿè±å¯Œã€æ³¨é‡äººéš›é€£çµçš„å¤–äº¤å®¶ï¼Œæ‚¨éœ€è¦æº«æš–ã€å…·æœ‰æ·±åº¦å’Œæ•…äº‹æ„Ÿçš„é¦™æ°£ã€‚æ‚¨çš„é¦™æ°£å°‡åœ¨ç¹å¿™ä¸­å°‹æ±‚æƒ…æ„Ÿæ”¯æŒï¼Œæˆ–åœ¨ç¤¾äº¤ä¸­æ•£ç™¼è¦ªåˆ‡é­…åŠ›ã€‚',
Â  Â  fragrance: 'ğŸ”¥ æ±æ–¹èª¿ (Oriental / Amber) / ğŸŒ¸ èŠ±é¦™èª¿ (Floral) / ğŸ§ ç¾é£Ÿèª¿ (Gourmand)'
Â  },
Â  SJ: {
Â  Â  category: 'ä¸‰ã€å®ˆè¡›è€… (The Sentinels)',
Â  Â  desc: 'ä½œç‚ºå‹™å¯¦å¯é ã€éµå¾ªè¦å‰‡çš„å®ˆè¡›è€…ï¼Œæ‚¨åæ„›æ¸…æ™°ã€å¯é ã€ä¸éåˆ†å¼µæšçš„ã€Œå®‰å…¨ã€é¦™æ°£ã€‚æ‚¨çš„é¦™æ°£å¿…é ˆå®Œç¾éé—œï¼Œå¸¶ä¾†å®‰å¿ƒæ„Ÿå’Œå°ˆæ¥­æ„Ÿã€‚',
Â  Â  fragrance: 'ğŸ‘” é¦¥å¥‡èª¿ (Fougere) / ğŸ§¼ æ½”æ·¨éºé¦™èª¿ (Clean Musk) / ğŸŠ æŸ‘æ©˜èª¿ (Citrus)'
Â  },
Â  SP: {
Â  Â  category: 'å››ã€æ¢éšªå®¶ (The Explorers)',
Â  Â  desc: 'ä½œç‚ºæ´»åœ¨ç•¶ä¸‹ã€ç†±æ„›è‡ªç”±èˆ‡åˆºæ¿€çš„æ¢éšªå®¶ï¼Œæ‚¨éœ€è¦å……æ»¿æ´»åŠ›ã€å‹•æ„Ÿæˆ–å¸¶æœ‰å¼·çƒˆå€‹æ€§çš„é¦™æ°£ã€‚æ‚¨çš„é¦™æ°£æ‡‰åæ˜ å¿«ç¯€å¥çš„ç”Ÿæ´»å’Œå¤–å‘çš„å€‹æ€§ã€‚',
Â  Â  fragrance: 'ğŸ§¥ çš®é©èª¿ (Leather) / ğŸŒ¶ï¸ è¾›é¦™èª¿ (Spicy) / ğŸŒŠ æ°´ç”Ÿèª¿ (Aquatic)'
Â  }
};

// å°‡å•é¡Œå…§å®¹å¾ UI ä¸­åˆ†é›¢å‡ºä¾†ï¼Œæ–¹ä¾¿ç®¡ç† (ä¿ç•™åŸå•é¡Œå’Œé¸é …æ–‡æ¡ˆ)
const questions = [
  { id: 1, title: 'ğŸ¨ é‘‘è³è—è¡“å“æ™‚ï¼Œæ‚¨çš„ç›®å…‰æœƒæœ€å…ˆè¢«ä»€éº¼å¸å¼•ï¼Ÿ', options: [{ key: 'N', text: 'A. ä½œå“èƒŒå¾Œçš„å“²å­¸æ€æƒ³ã€è—è¡“å®¶çš„æŠ½è±¡æ¦‚å¿µï¼Œä»¥åŠå®ƒçµ¦äºˆçš„ç„¡é™è¯æƒ³ç©ºé–“ã€‚'}, { key: 'S', text: 'B. ä½œå“çš„æè³ªã€ç²¾æº–çš„æŠ€æ³•ã€ç”Ÿå‹•çš„è‰²å½©è¡¨ç¾ï¼Œä»¥åŠå®ƒæ‰€æç¹ªçš„çœŸå¯¦å ´æ™¯ã€‚'} ] },
  { id: 2, title: 'ğŸ’” åœ¨ç·Šå¼µçš„äººéš›è¡çªä¸­ï¼Œæ‚¨èªç‚ºé¦™æ°£çš„ä½œç”¨æ˜¯ä»€éº¼ï¼Ÿ', options: [{ key: 'T', text: 'A. å¹«åŠ©æˆ‘ä¿æŒæ¸…é†’å’Œå†·éœï¼Œæ•£ç™¼å‡ºå°ˆæ¥­ã€ä¸è¢«æƒ…ç·’å½±éŸ¿çš„ç©©å®šæ°£å ´ã€‚'}, { key: 'F', text: 'B. æŸ”åŒ–å‘¨åœçš„æ°›åœï¼Œå‰µé€ ä¸€å€‹æº«æš–ã€æ’«æ…°çš„ç©ºé–“ï¼Œå¹«åŠ©äººèˆ‡äººå»ºç«‹é€£çµã€‚'} ] },
  { id: 3, title: 'ğŸ—“ï¸ é—œæ–¼æ‚¨æ”¶è—çš„å„ç¨®é¦™æ°´ï¼Œå“ªå€‹æè¿°æœ€è²¼åˆ‡ï¼Ÿ', options: [{ key: 'J', text: 'A. æˆ‘æœƒæ ¹æ“šå ´åˆã€æœè£ã€ç”šè‡³æ˜¯ä¸€é€±çš„è¨ˆåŠƒï¼Œç‚ºé¦™æ°´é€²è¡Œç²¾æº–çš„åˆ†é¡å’Œé¸æ“‡ã€‚'}, { key: 'P', text: 'B. æˆ‘éš¨å¿ƒæ‰€æ¬²åœ°ä½¿ç”¨é¦™æ°´ï¼Œå–œæ­¡å³èˆˆç–Šé¦™ï¼Œç›¸ä¿¡æ°£å‘³å¸¶ä¾†ç•¶ä¸‹çš„æ„Ÿå®˜é©šå–œã€‚'} ] },
  { id: 4, title: 'ğŸŒƒ é€±æœ«æ™šä¸Šï¼Œæ‚¨æ¸´æœ›æ•£ç™¼å“ªä¸€ç¨®é¦™æ°£é¢¨æ ¼ï¼Ÿ', options: [{ key: 'E', text: 'A. æ¿ƒéƒã€å…·æœ‰é­…åŠ›ä¸”å¼µæšçš„é¦™æ°£ï¼Œå¸Œæœ›æˆç‚ºç¤¾äº¤èšæœƒä¸­æœ€ä»¤äººé›£å¿˜çš„ç„¦é»ã€‚'}, { key: 'I', text: 'B. å…§æ–‚ã€æœ‰å±¤æ¬¡ä¸”èˆ’é©çš„é¦™æ°£ï¼Œå®ƒæ˜¯æˆ‘ç¨è™•æ™‚çš„å„€å¼æ„Ÿï¼Œåªç‚ºæ‡‚æˆ‘çš„äººåœç•™ã€‚'} ] }
];
const totalQuestions = questions.length;


export default function App() {
  const [currentPage, setCurrentPage] = useState<Page>('intro');
  const [score, setScore] = useState<Record<ScoreKey, number>>({
    N: 0, S: 0, J: 0, P: 0, T: 0, F: 0, E: 0, I: 0
  });
  const [result, setResult] = useState<{ mbtiType: string; resultData: ResultData } | null>(null);
  
  // è¨ˆç®—é€²åº¦æ¢ç™¾åˆ†æ¯”
  const getProgress = useMemo(() => {
    if (currentPage === 'intro') return 0;
    if (currentPage === 'result') return 100;
    return ((currentPage as number) / totalQuestions) * 100;
  }, [currentPage]);


  const calculateResult = useCallback((finalScore: Record<ScoreKey, number>) => {
    const N_S = finalScore.N > finalScore.S ? 'N' : 'S';
    const J_P = finalScore.J > finalScore.P ? 'J' : 'P';
    const T_F = finalScore.T > finalScore.F ? 'T' : 'F';
    const E_I = finalScore.E > finalScore.I ? 'E' : 'I';

    const mbtiType = E_I + N_S + T_F + J_P;
    
    // **Bug ä¿®æ­£æ ¸å¿ƒé‚è¼¯:** ç¢ºä¿ S é¡å‹èƒ½å¤ æº–ç¢ºåœ°å°å‘ SP æˆ– SJã€‚
    let finalKey: CategoryKey;
    
    if (N_S === 'N') {
      // åˆ†æå®¶ (NT) æˆ– å¤–äº¤å®¶ (NF)
      finalKey = T_F === 'T' ? 'NT' : 'NF';
    } else {
      // å®ˆè¡›è€… (SJ) æˆ– æ¢éšªå®¶ (SP)
      // S_F_ å‚¾å‘æ–¼ SJ (å®ˆè¡›è€…), S_T_ å‚¾å‘æ–¼ SP (æ¢éšªå®¶)
      finalKey = T_F === 'F' ? 'SJ' : 'SP'; 
    }

    const resultData = resultsMap[finalKey];

    setResult({ mbtiType, resultData });
    setCurrentPage('result');
  }, []);

  // è™•ç†å›ç­”
  const handleAnswer = useCallback((scoreKey: ScoreKey, isLastQuestion: boolean = false) => {
    // å„ªå…ˆæ›´æ–°åˆ†æ•¸
    setScore(prevScore => {
        const newScore = { ...prevScore, [scoreKey]: prevScore[scoreKey] + 1 };
        
        if (isLastQuestion) {
            // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œå‰‡èª¿ç”¨ calculateResult
            calculateResult(newScore);
        } else {
            // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€é¡Œï¼Œå‰‡åˆ‡æ›é é¢
            setCurrentPage(prevPage => {
                if (typeof prevPage === 'number' && prevPage < totalQuestions) {
                    return (prevPage + 1) as 1 | 2 | 3 | 4;
                }
                return prevPage;
            });
        }
        return newScore;
    });

  }, [calculateResult]);

  const startQuiz = useCallback(() => {
    setCurrentPage(1);
  }, []);

  const restartQuiz = useCallback(() => {
    setCurrentPage('intro');
    setScore({ N: 0, S: 0, J: 0, P: 0, T: 0, F: 0, E: 0, I: 0 });
    setResult(null);
  }, []);

  const exitToIntro = useCallback(() => {
    restartQuiz();
  }, [restartQuiz]);

  const showExitButton = currentPage !== 'intro' && currentPage !== 'result';
  const showProgressBar = currentPage !== 'intro';

  // =========================================================
  // UI æ¸²æŸ“é‚è¼¯
  // =========================================================
  const renderQuestion = (q: (typeof questions)[0]) => (
    <div key={q.id} className="text-left">
      <h2 
        className="text-[80px] text-[#B8860B] mb-[70px] text-center"
        style={{ 
          fontFamily: "'Lantinghei SC', 'å…°äº­é»‘-ç®€', 'Inter', sans-serif", 
          fontWeight: 500 
        }}
      >
        {q.title}
      </h2>
      {q.options.map((option, index) => (
        <button
          key={index}
          // å‚³é isLastQuestion: æª¢æŸ¥ç•¶å‰å•é¡Œ ID æ˜¯å¦ç­‰æ–¼ç¸½å•é¡Œæ•¸
          onClick={() => handleAnswer(option.key as ScoreKey, q.id === totalQuestions)}
          className="block w-full py-[50px] px-[70px] my-[50px] bg-[#282828] border-2 border-[#555] rounded-[15px] cursor-pointer text-[60px] text-[#E0E0E0] text-left transition-all hover:bg-[#383838] hover:border-[#B8860B] hover:text-white"
          style={{ 
            fontFamily: "'Inter', 'Microsoft YaHei UI', sans-serif", 
            fontWeight: 300 
          }}
        >
          {option.text}
        </button>
      ))}
    </div>
  );


  return (
    <div 
      className="w-[2160px] h-[3840px] bg-[#121212] text-[#E0E0E0] flex justify-center items-center overflow-hidden"
      style={{ fontFamily: "'Inter', 'Microsoft YaHei UI', 'Microsoft YaHei', sans-serif" }}
    >
      <div className="w-[90%] max-w-[1900px] h-[90%] bg-[rgba(25,25,25,0.95)] border-[5px] border-[#B8860B] shadow-[0_0_50px_rgba(184,134,11,0.4)] rounded-[20px] px-[120px] py-[100px] text-center flex flex-col justify-between relative">
        
        {/* Exit Button */}
        {showExitButton && (
          <button
            onClick={exitToIntro}
            className="absolute top-[70px] left-[70px] w-[100px] h-[100px] bg-transparent border-2 border-[#B8860B] rounded-full text-[#B8860B] text-[60px] leading-[90px] cursor-pointer z-10 transition-all hover:bg-[#B8860B] hover:text-[#121212] flex items-center justify-center"
          >
            Ã—
          </button>
        )}

        {/* Header (ä½¿ç”¨ Figma Asset Logo) */}
        <div className="pb-5 mb-8">
          <div className="mb-2 flex justify-center">
            <img 
              src={logoImage} 
              alt="SCENTATION Logo" 
              // èª¿æ•´åœ–ç‰‡å¤§å°ä»¥ç¬¦åˆæ¨™é¡Œå€åŸŸï¼Œä¸¦ä¿ç•™é¦™æª³é‡‘å…‰æšˆæ•ˆæœ
              className="h-[160px] w-auto" 
              style={{
                filter: 'drop-shadow(0 0 10px rgba(184, 134, 11, 0.8))'
              }}
            />
          </div>
          <p 
            className="text-[50px] text-[#AAAAAA] font-light"
            style={{ fontFamily: "'Inter', sans-serif" }}
          >
            å“å‘³å“²å­¸ï¼šç‚ºæ‚¨çš„éå‡¡é¢¨æ ¼ï¼Œå°‹è¦“å°ˆå±¬æ°£å‘³ç°½åã€‚
          </p>
        </div>

        {/* Progress Bar */}
        {showProgressBar && (
          <div className="w-full h-[30px] bg-[#333] rounded-[15px] mb-[50px] overflow-hidden">
            <div 
              className="h-full bg-[#B8860B] transition-all duration-500"
              style={{ width: `${getProgress}%` }}
            />
          </div>
        )}

        {/* Content Area */}
        <div className="flex-grow pb-[100px]">
          
          {/* Intro Page */}
          {currentPage === 'intro' && (
            <div className="text-center">
              <h2 
                className="text-[80px] text-[#B8860B] mb-[70px]"
                style={{ fontFamily: "'Lantinghei SC', 'å…°äº­é»‘-ç®€', 'Inter', sans-serif", fontWeight: 500 }}
              >
                å•Ÿç¨‹ï¼Œè§£é–æ‚¨çš„é¦™æ°£å¯†ç¢¼
              </h2>
              <p className="text-[55px] leading-[1.8] text-[#E0E0E0] mb-[50px]">
                æ–¼ç¬æ¯è¬è®Šçš„éƒ½æœƒç¯€å¥ä¸­ï¼Œæ‚¨çš„é¸æ“‡å®šç¾©äº†æ‚¨çš„æ°£å ´ã€‚æœ¬æ¸¬è©¦é€é **4 é¡Œç²¾ç…‰çš„ç¾å­¸æƒ…å¢ƒ**ï¼Œè¿…é€Ÿå‰–ææ‚¨çš„æ ¸å¿ƒäººæ ¼ç‰¹è³ªï¼Œç²¾æº–æ¨è–¦æœ€èƒ½å½°é¡¯æ‚¨å€‹äººé­…åŠ›çš„å¥¢è¯é¦™èª¿å®¶æ—ã€‚
              </p>
              
              {/* ç§»é™¤ H3 å€å¡Šï¼Œåªä¿ç•™é–‹å§‹æŒ‰éˆ• */}
              <button
                onClick={startQuiz}
                className="mt-[100px] px-[100px] py-[50px] bg-[#B8860B] text-[#121212] border-none rounded-[10px] cursor-pointer text-[70px] tracking-[5px] transition-colors hover:bg-[#D4AF37]"
                style={{ fontFamily: "'Lantinghei SC', 'å…°äº­é»‘-ç®€', 'Inter', sans-serif", fontWeight: 'bold' }}
              >
                å³åˆ»å•Ÿå‹• æ°£å‘³æ¢ç´¢
              </button>
            </div>
          )}

          {/* Render Questions (1 to 4) */}
          {questions.map(q => 
            currentPage === q.id && renderQuestion(q)
          )}

          {/* Result Page */}
          {currentPage === 'result' && result && (
            <div className="pt-[50px] border-t-[3px] border-[#555] text-center">
              <h2 
                className="text-[120px] text-[#B8860B] mb-[40px]"
                style={{ fontFamily: "'Lantinghei SC', 'å…°äº­é»‘-ç®€', 'Inter', sans-serif", fontWeight: 500 }}
              >
                ğŸ‰ ä½ çš„å°ˆå±¬å¥¢è¯é¦™èª¿ï¼š
                <br />
                <span className="text-[90px]">{result.resultData.category}</span>
                <br />
                <span className="text-[70px] font-normal">(æ¨æ¸¬é¡å‹ {result.mbtiType})</span>
              </h2>
              <p className="text-[60px] leading-[1.6] text-[#C0C0C0] mb-[60px]">
                {result.resultData.desc}
              </p>
              <div className="bg-[#252525] border-4 border-[#B8860B] rounded-[15px] p-[80px] mt-[50px]">
                <strong 
                  className="text-[#B8860B] text-[75px] block mb-[30px]"
                  style={{ fontFamily: "'Lantinghei SC', 'å…°äº­é»‘-ç®€', 'Inter', sans-serif" }}
                >
                  âšœï¸ ä½ çš„ã€SCENTATIONã€‘æ¨è–¦é¦™èª¿å®¶æ—ï¼š
                </strong>
                <p className="text-[65px] text-[#E0E0E0]" style={{ fontWeight: 300 }}>
                  {result.resultData.fragrance}
                </p>
              </div>
              <button
                onClick={restartQuiz}
                className="mt-[100px] px-[100px] py-[50px] bg-[#B8860B] text-[#121212] border-none rounded-[10px] cursor-pointer text-[70px] tracking-[5px] transition-colors hover:bg-[#D4AF37]"
                style={{ fontFamily: "'Lantinghei SC', 'å…°äº­é»‘-ç®€', 'Inter', sans-serif", fontWeight: 'bold' }}
              >
                é‡æ–°æ¢ç´¢
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
